name: Build and Release

on:
  push:
    branches: [master]
    tags:
      - 'v*'
  pull_request:
    branches: [master]
  release:
    types: [published]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    permissions:
      contents: read
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: bash packaging/linux/install-build-deps.sh

      - name: Set PKG_CONFIG_PATH
        run: echo "PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install UI dependencies
        run: npm ci
        working-directory: ui

      - name: Build UI
        run: npm run build
        working-directory: ui

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Run tests
        run: cargo test --manifest-path core/Cargo.toml

  build:
    needs: test
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            os: linux
            arch: x86_64
            binary_name: desktop-runtime-core
            ext: ''
            size_limit_mb: 12
            package_format: appimage
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
            os: windows
            arch: x86_64
            binary_name: desktop-runtime-core.exe
            ext: .exe
            size_limit_mb: 18
            package_format: msi
          - runner: macos-14
            target: x86_64-apple-darwin
            os: macos
            arch: x86_64
            binary_name: desktop-runtime-core
            ext: ''
            size_limit_mb: 20
            package_format: app
          - runner: macos-14
            target: aarch64-apple-darwin
            os: macos
            arch: aarch64
            binary_name: desktop-runtime-core
            ext: ''
            size_limit_mb: 20
            package_format: app

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            VERSION="${VERSION#v}"
          else
            VERSION=$(grep '^version' core/Cargo.toml | head -1 | cut -d'"' -f2)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Prepare packaging env
        run: |
          bash packaging/scripts/write-build-env.sh "${{ steps.version.outputs.version }}"
          cat packaging/build-env.env >> $GITHUB_ENV
        shell: bash

      - name: Log build context
        run: |
          echo "=============================================="
          echo "BUILD CONTEXT"
          echo "=============================================="
          echo "runner:    ${{ matrix.runner }}"
          echo "os:        ${{ matrix.os }}"
          echo "arch:      ${{ matrix.arch }}"
          echo "target:    ${{ matrix.target }}"
          echo "version:   ${{ steps.version.outputs.version }}"
          echo "ref:       ${{ github.ref }}"
          echo "event:     ${{ github.event_name }}"
          echo "package:   ${{ matrix.package_format }} (size_limit=${{ matrix.size_limit_mb }} MB)"
          echo "=============================================="

      - name: Install Linux dependencies
        if: matrix.os == 'linux'
        run: bash packaging/linux/install-build-deps.sh

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install UI dependencies
        run: npm ci
        working-directory: ui

      - name: Build UI
        run: npm run build
        working-directory: ui

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Log tool versions
        if: matrix.os != 'windows'
        shell: bash
        run: |
          echo "--- Tool versions ---"
          node -v
          npm -v
          rustc --version
          cargo --version
          if command -v pkg-config 2>/dev/null; then pkg-config --version; fi
          echo "--------------------"

      - name: Set PKG_CONFIG_PATH
        if: matrix.os == 'linux'
        run: echo "PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig" >> $GITHUB_ENV

      - name: Build release binary
        run: |
          echo ">> Building release binary for target ${{ matrix.target }}"
          cargo build --release --manifest-path core/Cargo.toml --target ${{ matrix.target }}
          echo ">> Build finished successfully"

      - name: Check binary size
        id: size
        shell: bash
        run: |
          BINARY="target/${{ matrix.target }}/release/${{ matrix.binary_name }}"
          echo ">> Binary path: $BINARY"
          if [ ! -f "$BINARY" ]; then
            echo "ERROR: Binary not found at $BINARY"
            exit 1
          fi
          SIZE_BYTES=$(wc -c < "$BINARY" | tr -d ' \n')
          SIZE_MB=$((SIZE_BYTES / 1048576))
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo ">> Binary size: ${SIZE_MB} MB (limit: ${{ matrix.size_limit_mb }} MB)"
          if [ "$SIZE_MB" -gt "${{ matrix.size_limit_mb }}" ]; then
            echo "ERROR: Binary exceeds size limit of ${{ matrix.size_limit_mb }} MB"
            exit 1
          fi
          echo ">> Size check passed"

      - name: Install WiX 4
        if: matrix.package_format == 'msi'
        run: dotnet tool install --global wix

      - name: Package (Windows MSI)
        if: matrix.package_format == 'msi'
        run: |
          $env:SourceDir = (Resolve-Path "target\x86_64-pc-windows-msvc\release").Path
          $env:Version = "${{ steps.version.outputs.version }}"
          & ./packaging/windows/build-msi.ps1
        working-directory: ${{ github.workspace }}
        shell: pwsh

      - name: Package (macOS .app)
        if: matrix.package_format == 'app'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          ARCH: ${{ matrix.arch }}
          TARGET: ${{ matrix.target }}
        run: chmod +x packaging/macos/build-app-pkg.sh && ./packaging/macos/build-app-pkg.sh

      - name: Cache appimagetool
        if: matrix.package_format == 'appimage'
        uses: actions/cache@v4
        with:
          path: .cache/appimagetool
          key: appimagetool-1.9.1-linux

      - name: Package (Linux AppImage)
        if: matrix.package_format == 'appimage'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TARGET: ${{ matrix.target }}
        run: chmod +x packaging/linux/build-appimage.sh && ./packaging/linux/build-appimage.sh

      - name: Upload artifact (Windows MSI)
        if: matrix.package_format == 'msi'
        uses: actions/upload-artifact@v4
        with:
          name: desktop-runtime-${{ steps.version.outputs.version }}-windows-x86_64
          path: target/wix/desktop-runtime-${{ steps.version.outputs.version }}-x86_64-pc-windows-msvc.msi

      - name: Upload artifact (macOS)
        if: matrix.package_format == 'app'
        uses: actions/upload-artifact@v4
        with:
          name: desktop-runtime-${{ steps.version.outputs.version }}-macos-${{ matrix.arch }}
          path: |
            desktop-runtime-${{ steps.version.outputs.version }}-${{ matrix.arch }}-apple-darwin.tar.gz
            desktop-runtime-${{ steps.version.outputs.version }}-${{ matrix.arch }}-apple-darwin.pkg

      - name: Upload artifact (Linux AppImage)
        if: matrix.package_format == 'appimage'
        uses: actions/upload-artifact@v4
        with:
          name: desktop-runtime-${{ steps.version.outputs.version }}-linux-x86_64
          path: |
            desktop-runtime-${{ steps.version.outputs.version }}-x86_64.AppImage
            desktop-runtime-${{ steps.version.outputs.version }}-linux-installer.tar.gz

      - name: Build summary (success)
        if: success()
        run: |
          echo "=============================================="
          echo "BUILD SUCCEEDED"
          echo "=============================================="
          echo "version:   ${{ steps.version.outputs.version }}"
          echo "runner:    ${{ matrix.runner }}"
          echo "target:    ${{ matrix.target }}"
          echo "binary:    target/${{ matrix.target }}/release/${{ matrix.binary_name }}"
          echo "size:      ${{ steps.size.outputs.size_mb }} MB (limit ${{ matrix.size_limit_mb }} MB)"
          echo "package:   ${{ matrix.package_format }}"
          echo "=============================================="

      - name: Failure context
        if: failure()
        run: |
          echo "=============================================="
          echo "BUILD FAILED - CONTEXT FOR DEBUGGING"
          echo "=============================================="
          echo "runner:    ${{ matrix.runner }}"
          echo "os:        ${{ matrix.os }}"
          echo "target:    ${{ matrix.target }}"
          echo "version:   ${{ steps.version.outputs.version }}"
          echo "ref:       ${{ github.ref }}"
          echo "event:     ${{ github.event_name }}"
          echo "package:   ${{ matrix.package_format }}"
          echo ""
          echo "Key paths (for local repro):"
          echo "  binary:  target/${{ matrix.target }}/release/${{ matrix.binary_name }}"
          echo "  core:    core/"
          echo "  ui:      ui/"
          echo "=============================================="

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    concurrency:
      group: release-create-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Log release contents
        run: |
          echo "=============================================="
          echo "RELEASE ARTIFACTS"
          echo "=============================================="
          find artifacts -type f 2>/dev/null | sort
          echo "=============================================="

      - name: Create Release and upload artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
          name: Release ${{ github.event.release.tag_name || github.ref_name }}
          body_path: RELEASE_${{ github.event.release.tag_name || github.ref_name }}.md
          body: ${{ github.event.release.body }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
