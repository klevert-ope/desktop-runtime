# Packaging

This directory contains everything needed to build installers and distributable artifacts for Desktop Runtime on Windows, macOS, and Linux.

## Layout

- **`metadata.toml`** – Single source of truth for app name, bundle ID, description, and Windows upgrade code. Version comes from git tag or `core/Cargo.toml` at build time.
- **`build-env.env`** – Generated by `scripts/write-build-env.sh` (CI or local). Exports `VERSION`, `APP_NAME`, `BUNDLE_ID`, etc. for packaging scripts. Do not commit.
- **`LICENSE.txt`** – Apache-2.0 license text included in installers and Linux installer bundle.
- **`desktop-runtime.desktop.in`** – Template for the Linux `.desktop` file; `@EXEC@` is replaced with the executable path by the AppImage build or install script.
- **`windows/`** – WiX installer (MSI), License.rtf, and `build-msi.ps1`.
- **`macos/`** – `.app` / `.pkg` build script, `distribution.xml.in`, `Info.plist.in`, and `resources/` (welcome, license, background).
- **`linux/`** – `install-build-deps.sh` (multi-distro), `install-desktop-runtime.sh` (guided install), and `build-appimage.sh`.
- **`icons/`** – Canonical icon: `react.png` (512×512 or 1024×1024 PNG). `.ico` (Windows) and `.icns` (macOS) are generated at pack time from this file.
- **`scripts/`** – Helper scripts (e.g. `write-build-env.sh`).

## Single source of truth

- **Version:** From git tag (e.g. `v0.3.0`) or `core/Cargo.toml` `version` field.
- **App name, bundle ID, description:** From `packaging/metadata.toml`.
- **Icon:** `packaging/icons/react.png`; other formats are generated during packaging.

## Required tools (per platform)

- **Windows:** WiX (`dotnet tool install --global wix`). The build script adds `WixToolset.UI.wixext` 6.0.2. Optional: tool to generate `.ico` from PNG if not using the built-in step in `build-msi.ps1`.
- **macOS:** Xcode Command Line Tools (`sips`, `iconutil`), `pkgbuild`, `productbuild`.
- **Linux:** `appimagetool` 1.9.1 (downloaded by the build script if missing). Optional: `zenity` or `dialog` for the guided install script.

## Running packaging locally

From the repository root, after building the release binary:

1. **Prepare env (optional if CI already did it):**
   ```bash
   bash packaging/scripts/write-build-env.sh 0.3.0
   export $(grep -v '^#' packaging/build-env.env | xargs)
   ```

2. **Linux (AppImage):**
   ```bash
   export VERSION=0.3.0 TARGET=x86_64-unknown-linux-gnu
   ./packaging/linux/build-appimage.sh
   ```

3. **macOS (.app + .pkg):**
   ```bash
   export VERSION=0.3.0 ARCH=x86_64 TARGET=x86_64-apple-darwin
   ./packaging/macos/build-app-pkg.sh
   ```
   For ARM: `ARCH=aarch64 TARGET=aarch64-apple-darwin`.

4. **Windows (MSI):**
   From PowerShell, after `dotnet tool install --global wix`:
   ```powershell
   $env:SourceDir = (Resolve-Path "target\x86_64-pc-windows-msvc\release").Path
   $env:Version = "0.3.0"
   # Optional: set $env:APP_NAME, $env:MANUFACTURER, $env:UPGRADE_CODE or source build-env.env
   .\packaging\windows\build-msi.ps1
   ```
   If `packaging/icons/react.ico` is missing, the script generates it from `react.png` using .NET.

## Supported Linux distros (install-build-deps.sh)

- **Debian / Ubuntu:** `apt-get` — build-essential, pkg-config, libssl-dev, libgtk-3-dev, libgdk-pixbuf2.0-dev, librsvg2-dev, libwebkit2gtk-4.0-dev, libwebkit2gtk-4.1-dev, libjavascriptcoregtk-4.1-dev, libsoup-3.0-dev, libsoup2.4-dev, libayatana-appindicator3-dev, libxdo-dev, patchelf.
- **Fedora / RHEL:** `dnf` — gcc, gcc-c++, make, pkg-config, openssl-devel, gtk3-devel, gdk-pixbuf2-devel, librsvg2-devel, webkit2gtk4.1-devel, libsoup3-devel, libsoup-devel, libappindicator-gtk3-devel, libxdo-devel, patchelf.
- **Arch:** `pacman` — base-devel, pkg-config, openssl, gtk3, gdk-pixbuf2, librsvg, webkit2gtk-4.1, libsoup3, libsoup, libayatana-appindicator3, libxdo, patchelf.

The script auto-detects the package manager; if your distro is unsupported it exits with a message pointing to this README.

## Icon

Place a single PNG at **`packaging/icons/react.png`** (e.g. 512×512 or 1024×1024). It is used by the core app (embedded) and by packaging:

- **Windows:** `build-msi.ps1` generates `react.ico` from it (or uses an existing one).
- **macOS:** `build-app-pkg.sh` generates `.icns` and uses the PNG for the installer background.
- **Linux:** The PNG is copied into the AppDir and referenced by the `.desktop` file.

Do not commit `.ico` or `.icns`; they are produced at pack time.
